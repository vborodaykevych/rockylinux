name: Build and Push Rocky Linux Images

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *" # Daily builds at midnight UTC

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version:
          - 9
          - 10
        platform:
          - amd64
          - arm64
          - ppc64le
          - s390x
        variant:
          - base
          - minimal
        security:
          - root
          - nonroot
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set TAG_SUFFIX
        id: tag_suffix
        run: |
          VERSION_PREFIX=""
          if [[ "${{ matrix.version }}" != "10" ]]; then
            VERSION_PREFIX="${{ matrix.version }}-"
          fi

          if [[ "${{ matrix.variant }}" == "base" && "${{ matrix.security }}" == "root" ]]; then
            TAG_SUFFIX="${VERSION_PREFIX}${{ matrix.platform }}"
          else
            TAG_SUFFIX="${VERSION_PREFIX}${{ matrix.platform }}${{ matrix.variant == 'minimal' && '-minimal' || '' }}${{ matrix.security == 'nonroot' && '-nonroot' || '' }}"
          fi
          echo "TAG_SUFFIX=$TAG_SUFFIX" >> $GITHUB_ENV

      - name: Build Initial Image
        run: |
          DOCKERFILE="Dockerfile.${{ matrix.variant }}${{ matrix.security == 'nonroot' && '.nonroot' || '' }}"
          IMAGE_TAG="${{ secrets.DOCKER_USERNAME }}/rockylinux:${TAG_SUFFIX}"

          # Version 9 uses rockylinux, version 10 uses rockylinux/rockylinux
          if [[ "${{ matrix.version }}" == "9" ]]; then
            BASE_IMAGE="rockylinux"
          else
            BASE_IMAGE="rockylinux/rockylinux"
          fi

          echo "Building initial image $IMAGE_TAG using $DOCKERFILE..."
          docker buildx build \
            --platform linux/${{ matrix.platform }} \
            --file $DOCKERFILE \
            --build-arg VERSION=${{ matrix.version }} \
            --build-arg IMAGE=$BASE_IMAGE \
            --tag $IMAGE_TAG \
            --load .

      - name: Extract Minor Version
        run: |
          IMAGE_TAG="${{ secrets.DOCKER_USERNAME }}/rockylinux:${TAG_SUFFIX}"
          echo "Extracting MINOR_VERSION from local image $IMAGE_TAG..."
          MINOR_VERSION=$(docker run --rm $IMAGE_TAG cat /etc/os-release | grep VERSION_ID | cut -d '"' -f 2)
          echo "Extracted MINOR_VERSION: $MINOR_VERSION"
          echo $MINOR_VERSION > minor_version.txt

      - name: Extract Filesystem
        run: |
          IMAGE_TAG="${{ secrets.DOCKER_USERNAME }}/rockylinux:${TAG_SUFFIX}"
          echo "Extracting filesystem for $IMAGE_TAG..."
          docker save $IMAGE_TAG -o layer.tar

          mkdir -p extracted /tmp/rootfs
          tar -xf layer.tar -C extracted

          for layer in extracted/blobs/sha256/*; do
            if file "$layer" | grep -q 'tar archive'; then
              tar --skip-old-files -xf "$layer" -C /tmp/rootfs
            fi
          done

          # Fix permissions recursively
          echo "Adjusting permissions in /tmp/rootfs..."
          chmod -R +r /tmp/rootfs || true

          # Verify the filesystem to ensure critical files exist
          echo "Verifying extracted filesystem..."
          if [ ! -f "/tmp/rootfs/bin/bash" ]; then
            echo "Error: /bin/bash not found in the reconstructed filesystem!"
            exit 1
          fi

          # Repackage filesystem into layer.tar.xz
          echo "Repackaging filesystem into layer.tar.xz..."
          tar -cf layer.tar -C /tmp/rootfs .
          xz -z layer.tar

      - name: Build Final Image
        run: |
          FINAL_DOCKERFILE=$(cat <<EOF
          FROM scratch
          ADD layer.tar.xz /
          ${{
            matrix.security == 'nonroot' && 'USER nonroot' || ''
          }}
          CMD ["/bin/bash"]
          EOF
          )

          echo "$FINAL_DOCKERFILE" > FinalDockerfile

          FINAL_TAG="${{ secrets.DOCKER_USERNAME }}/rockylinux:${TAG_SUFFIX}"
          echo "Building final image $FINAL_TAG..."
          docker buildx build \
            --platform linux/${{ matrix.platform }} \
            --file FinalDockerfile \
            --tag $FINAL_TAG \
            --provenance=true \
            --sbom=true \
            --push .

      - name: Upload Minor Version
        if: ${{ matrix.platform == 'amd64' && matrix.variant == 'base' && matrix.security == 'root' }}
        uses: actions/upload-artifact@v4
        with:
          name: MINOR_VERSION_${{ matrix.version }}
          path: minor_version.txt

  create_manifest:
    name: Create Multiarch Manifest
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Minor Version Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: MINOR_VERSION_*

      - name: Set Version Variables
        run: |
          MINOR_VERSION_9=$(cat MINOR_VERSION_9/minor_version.txt)
          MINOR_VERSION_10=$(cat MINOR_VERSION_10/minor_version.txt)
          echo "MINOR_VERSION_9=$MINOR_VERSION_9" >> $GITHUB_ENV
          echo "MINOR_VERSION_10=$MINOR_VERSION_10" >> $GITHUB_ENV
          echo "Using MINOR_VERSION_9=$MINOR_VERSION_9 and MINOR_VERSION_10=$MINOR_VERSION_10"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create Version 10 Manifests (latest)
        run: |
          REPO="${{ secrets.DOCKER_USERNAME }}/rockylinux"

          create_manifest() {
            local tag=$1
            shift
            local sources="$@"
            for i in 1 2 3 4 5; do
              echo "Creating manifest ${tag} (attempt $i)..."
              if docker buildx imagetools create --tag ${REPO}:${tag} ${sources}; then
                return 0
              fi
              echo "Retry in 30 seconds..."
              sleep 30
            done
            echo "Failed to create manifest ${tag}"
            return 1
          }

          # Base manifests: latest, 10, 10.x
          for TAG in "latest" "10" "${MINOR_VERSION_10}"; do
            create_manifest "${TAG}" "${REPO}:amd64 ${REPO}:arm64 ${REPO}:ppc64le ${REPO}:s390x"
          done

          # Minimal manifests: latest-minimal, 10-minimal, 10.x-minimal
          for TAG in "latest-minimal" "10-minimal" "${MINOR_VERSION_10}-minimal"; do
            create_manifest "${TAG}" "${REPO}:amd64-minimal ${REPO}:arm64-minimal ${REPO}:ppc64le-minimal ${REPO}:s390x-minimal"
          done

          # Nonroot manifests: nonroot, nonroot-minimal
          create_manifest "nonroot" "${REPO}:amd64-nonroot ${REPO}:arm64-nonroot ${REPO}:ppc64le-nonroot ${REPO}:s390x-nonroot"
          create_manifest "nonroot-minimal" "${REPO}:amd64-minimal-nonroot ${REPO}:arm64-minimal-nonroot ${REPO}:ppc64le-minimal-nonroot ${REPO}:s390x-minimal-nonroot"

      - name: Create Version 9 Manifests
        run: |
          REPO="${{ secrets.DOCKER_USERNAME }}/rockylinux"

          create_manifest() {
            local tag=$1
            shift
            local sources="$@"
            for i in 1 2 3 4 5; do
              echo "Creating manifest ${tag} (attempt $i)..."
              if docker buildx imagetools create --tag ${REPO}:${tag} ${sources}; then
                return 0
              fi
              echo "Retry in 30 seconds..."
              sleep 30
            done
            echo "Failed to create manifest ${tag}"
            return 1
          }

          # Base manifests: 9, 9.x
          for TAG in "9" "${MINOR_VERSION_9}"; do
            create_manifest "${TAG}" "${REPO}:9-amd64 ${REPO}:9-arm64 ${REPO}:9-ppc64le ${REPO}:9-s390x"
          done

          # Minimal manifests: 9-minimal, 9.x-minimal
          for TAG in "9-minimal" "${MINOR_VERSION_9}-minimal"; do
            create_manifest "${TAG}" "${REPO}:9-amd64-minimal ${REPO}:9-arm64-minimal ${REPO}:9-ppc64le-minimal ${REPO}:9-s390x-minimal"
          done
